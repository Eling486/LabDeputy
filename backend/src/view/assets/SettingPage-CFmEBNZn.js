import{_ as T,u as z,s as A,r as _,o as N,d as k,e as i,f as t,q as V,w as o,v as q,t as w,g as a,i as F,x as j,y as $,E as L,z as C,n as D,p as x,A as O,h,B as Z,C as G,D as H,j as J,m as I,k as K}from"./index-DGyKNxUo.js";import{E as Q}from"./el-alert-BKD2_SyK.js";import{B as W}from"./BoxLoading-qSX0lwTQ.js";import{E as p}from"./index-B8j5rCKw.js";import"./index-9z3CLSES.js";const X={class:"page"},Y={class:"page-box"},ee={class:"nav-box"},ae={class:"nav nav-right"},se={class:"nav-text"},le={class:"nav-text"},te={class:"setting-wrap"},re={__name:"SettingPage",setup(oe){const S=z(),{settings:s}=A(S),l=F("langs"),f=_({}),e=_({uid:null,username:null,realname:null,oldPassword:null,password:null,passwordRepeat:null}),P=_(!0),n=_(!1),y=_(!1),b=_(!1),E=async()=>{if(e.value.realname!==f.value.realname||e.value.password||e.value.passwordRepeat||e.value.oldPassword?b.value=!0:b.value=!1,e.value.oldPassword&&e.value.password&&e.value.passwordRepeat){y.value=!0;return}if(e.value.realname!==f.value.realname&&e.value.realname){y.value=!0;return}y.value=!1},R=async()=>{e.value.realname=f.value.realname,e.value.oldPassword=null,e.value.password=null,e.value.passwordRepeat=null,b.value=!1,y.value=!1},U=async()=>{if(n.value)return;if(!e.value.realname){p({message:l[s.value.lang].setting.msg_error_empty_realname,type:"error"});return}if(e.value.password&&!e.value.oldPassword){p({message:l[s.value.lang].setting.msg_error_empty_old_password,type:"error"});return}if(e.value.password!==e.value.passwordRepeat){p({message:l[s.value.lang].setting.msg_error_password_repeat,type:"error"});return}let u=new RegExp(/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d$@$!%*#?&]{6,}$/);if(e.value.password&&!u.test(e.value.password)){p({message:l[s.value.lang].setting.msg_error_password_illegal,type:"error"});return}n.value=!0;let r=!1,v={uid:e.value.uid,username:e.value.username};if(e.value.password){let d=x.sha256(`${e.value.username}${x.sha256(e.value.oldPassword)}`),c=x.sha256(`${e.value.username}${x.sha256(e.value.password)}`);v.password={old:d,new:c},r=!0}if(e.value.realname!==f.value.realname&&(v.realname=e.value.realname),!!await D("POST","/api/user/update",v).catch(d=>{if(d.code===-50104){p({message:l[s.value.lang].setting.msg_err_old_password,type:"error"}),n.value=!1;return}return p({message:d.msg||l[s.value.lang].msg_err_reload,type:"error"}),n.value=!1,console.log(d)})){if(await C(),r){p({message:l[s.value.lang].setting.msg_save_success_reload,type:"success"}),setTimeout(()=>{O(),location.reload()},5e3);return}p({message:l[s.value.lang].setting.msg_save_success,type:"success"}),n.value=!1,B()}},B=async()=>{P.value=!0,R(),await C();let u=await D("POST","/api/user/validate").catch(r=>console.log(r));e.value.uid=u.data.payload.uid,e.value.username=u.data.payload.username,e.value.realname=u.data.payload.realname,f.value=u.data.payload,P.value=!1};return N(async()=>{await B()}),(u,r)=>{const v=q,m=J,d=Q,c=K,M=L;return h(),k("main",X,[i("div",Y,[i("div",ee,[i("div",ae,[b.value&&!n.value?(h(),k("div",{key:0,class:"nav-item nav-btn",onClick:R},[t(v,null,{default:o(()=>[t(a(Z))]),_:1}),i("span",se,w(a(l)[a(s).lang].reset),1)])):V("",!0),y.value?(h(),k("div",{key:1,class:j(["nav-item nav-btn highlight",{saving:n.value}]),onClick:U},[n.value?V("",!0):(h(),$(v,{key:0},{default:o(()=>[t(a(G))]),_:1})),n.value?(h(),$(v,{key:1,class:"is-loading"},{default:o(()=>[t(a(H))]),_:1})):V("",!0),i("span",le,w(a(l)[a(s).lang].save),1)],2)):V("",!0)])]),t(W,{loading:P.value},null,8,["loading"]),i("div",te,[t(M,{class:"setting-form",model:e.value,trigger:"change","label-width":"auto",style:{"max-width":"600px"},"hide-required-asterisk":"",onInput:E,disabled:n.value},{default:o(()=>[t(m,{label:a(l)[a(s).lang].setting.uid,prop:"uid"},{default:o(()=>[I(w(e.value.uid),1)]),_:1},8,["label"]),t(m,{label:a(l)[a(s).lang].setting.username,prop:"uid"},{default:o(()=>[I(w(e.value.username),1)]),_:1},8,["label"]),t(d,{class:"setting-alert",type:"info","show-icon":"",closable:!1},{default:o(()=>[i("p",null,w(a(l)[a(s).lang].setting.alert_change_realname),1)]),_:1}),t(m,{label:a(l)[a(s).lang].setting.realname},{default:o(()=>[t(c,{modelValue:e.value.realname,"onUpdate:modelValue":r[0]||(r[0]=g=>e.value.realname=g),style:{width:"400px"},onInput:E},null,8,["modelValue"])]),_:1},8,["label"]),t(d,{class:"setting-alert",type:"info","show-icon":"",closable:!1},{default:o(()=>[i("p",null,w(a(l)[a(s).lang].setting.alert_change_password),1)]),_:1}),t(m,{label:a(l)[a(s).lang].setting.password_old,error:u.errorMsg},{default:o(()=>[t(c,{modelValue:e.value.oldPassword,"onUpdate:modelValue":r[1]||(r[1]=g=>e.value.oldPassword=g),type:"password",style:{width:"400px"},"show-password":"",autocomplete:"old-password"},null,8,["modelValue"])]),_:1},8,["label","error"]),t(m,{label:a(l)[a(s).lang].setting.password,error:u.errorMsg},{default:o(()=>[t(c,{modelValue:e.value.password,"onUpdate:modelValue":r[2]||(r[2]=g=>e.value.password=g),type:"password",style:{width:"400px"},"show-password":"",autocomplete:"new-password"},null,8,["modelValue"])]),_:1},8,["label","error"]),t(m,{label:a(l)[a(s).lang].setting.password_repeat,error:u.errorMsg},{default:o(()=>[t(c,{modelValue:e.value.passwordRepeat,"onUpdate:modelValue":r[3]||(r[3]=g=>e.value.passwordRepeat=g),type:"password",style:{width:"400px"},"show-password":"",autocomplete:"new-password"},null,8,["modelValue"])]),_:1},8,["label","error"])]),_:1},8,["model","disabled"])])])])}}},ve=T(re,[["__scopeId","data-v-09727069"]]);export{ve as default};
